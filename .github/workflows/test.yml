name: PR Checks (Smart VERSION enforcement)

on:
  pull_request:
    branches:
    - main

jobs:
  version-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Skip VERSION checks for doc/CI-only changes
      run: |
        git fetch origin main
        CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"

        if echo "$CHANGED_FILES" | grep -Ev '^(\\.github/|.*\\.md$)' | grep -q .; then
          exit 0
        else
          exit 1
        fi

    - name: Ensure VERSION file was changed
      if: success()
      run: |
        if git diff --name-only origin/main...HEAD | grep -q "^VERSION.txt$"; then
          echo "✅ VERSION.txt file changed"
        else
          echo "❌ VERSION must be bumped for app changes"
          exit 1
        fi

    - name: Validate VERSION format
      if: success()
      run: |
        VERSION=$(cat VERSION.txt)

        if echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+)?$'; then
          echo "✅ VERSION format valid: $VERSION"
        else
          echo "❌ Invalid VERSION format: $VERSION"
          echo "Expected: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-prerelease"
          exit 1
        fi

    - name: Ensure VERSION is new
      if: success()
      run: |
        VERSION=$(cat VERSION.txt)

        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "❌ Version v$VERSION already exists"
          exit 1
        else
          echo "✅ Version v$VERSION is new"
        fi
